<!DOCTYPE html>

<head>
  <title>P2 Projekt</title>
  <link rel='icon' type='image/png' href='./favicon.png' />
  <meta charset="UTF-8">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      font-family: sans-serif;
      font-size: 18px;
    }

    :root {
      --hue-neutral: 180;
      --hue-wrong: #ff0000;
      --hue-correct: #61ff9e;
    }

    body {
      --hue: var(--hue-neutral);
      padding: 0;
      margin: 0;
      display: flex;
      width: 100vw;
      height: 100vh;
      justify-content: center;
      align-items: center;
      background-color: hsl(var(--hue), 100%, 25%);
    }

    input[type="submit"] {
      --hue: var(--hue-neutral);
      border: 1px solid hsl(var(--hue), 100%, 100%);
      background-color: white;
      border-radius: 20px;
      padding: 5px 10px;
      color: hsl(var(--hue), 30%, 40%);
      cursor: pointer;
      margin: 80px;
      margin-top: 65px;
      box-shadow: 0 0 10px 2px;
      transition: 0.6s;
    }

    input[type="submit"]:hover {
      color: black;
      transform: scale(1.1);
    }

    input[type="checkbox"] {
      position: relative;
    }

    input[type="checkbox"]:hover {
      transform: scaleX(1.2);
    }

    input[type="number"] {
      position: relative;
      border-width: 1px;
      width: 4rem;
      border-radius: 4px;
    }

    .container {
      display: flex;
      flex-direction: column;
    }
  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body>
  <form id='form'>
    <label for='eksamenssætTypeVælger'><b>Vælg eksamenssæt type</b></label><br>
    <label for='exerciseAmount'></label>
    <div id='emneVælger'>
      <label for='emneVælger' hidden><b>Inkluder Emner:</b></label>
      <input type="checkbox" id="andengradspolynomiumOgLigning" name="andengradspolynomiumOgLigning" value="true">
      <label for="andengradspolynomiumOgLigning">Andengradspolynomium og -ligning</label><br>

      <input type="checkbox" id="talOgegnearter" name="talOgRegnearter" value="true">
      <label for="talOgRegnearter">Tal og regnearter</label><br>


      <input type="checkbox" id="ligninger" name="ligninger" value="true">
      <label for="ligninger">Ligninger</label><br>

      <input type="checkbox" id="trigonometri" name="trigonometri" value="true">
      <label for="trigonometri">Trigonometri</label><br>

      <input type="checkbox" id="funktioner" name="funktioner" value="true">
      <label for="funktioner">Funktioner</label><br>

      <input type="checkbox" id="geometri" name="geometri" value="true">
      <label for="geometri">Geometri</label><br>

      <input type="checkbox" id="differebtialregning" name="differebtialregning" value="true">
      <label for="differebtialregning">Differentialregning</label><br>

      <input type="checkbox" id="sandsynlighedOgKombinatorik" name="sandsynlighedOgKombinatorik" value="true">
      <label for="sandsynlighedOgKombinatorik">Sandsynlighed</label><br>

      <input type="checkbox" id="statistik" name="statistik" value="true">
      <label for="statistik">Statistik</label><br>

      <input type="checkbox" id="regression" name="regression" value="true">
      <label for="regression">Regression</label><br>

      <input type="checkbox" id="vektor2d" name="vektorerI2d" value="true">
      <label for="vektorerI2d">Vektorer i 2D</label><br>

      <input type="checkbox" id="vektorerI3d" name="vektorerI3d" value="true">
      <label for="vektorerI3d">Vektorer i 3D</label><br>

      <input type="checkbox" id="vektorfunktioner" name="vektorfunktioner" value="true">
      <label for="vektorfunktioner">Vektorfunktioner</label><br>

      <input type="checkbox" id="infinitesimalregning" name="infinitesimalregning" value="true">
      <label for="infinitesimalregning">Infinitesimalregning</label><br>

      <input type="checkbox" id="integralregning" name="integralregning" value="true">
      <label for="integralregning">Integralregning</label><br>

      <input type="checkbox" id="funktionerAfToVariable" name="funktionerAfToVariable" value="true">
      <label for="funktionerAfToVariable">Funktioner af to variable</label><br>
    </div><br>

    <!-- The amount of exercises you would to be generated and the button for submitting-->
    <label for="amount">Hvor mange opgaver vil du lave?</label>
    <input type="number" id="amount">
    <br><br>

    <input type='submit' value='Indsend'>
  </form>
  <script>
    /* eslint-disable no-undef */
    const convert = (input, output) => {
      MathJax.texReset();
      const options = MathJax.getMetricsFor(output);
      MathJax.tex2svgPromise(input, options).then((node) => {
        output.appendChild(node);
        MathJax.startup.document.clear();
        MathJax.startup.document.updateDocument();
      }).catch((err) => {
        output.appendChild(document.createElement('pre')).appendChild(document.createTextNode(err
          .message));
      }).then(() => {});
    };

    const baseUrl = window.location.href;

    document.querySelector('#form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const exerciseSet = await getExerciseSetFromServer(event);
      buildExercisePage(exerciseSet);
    });

    /**
     * Gets the generated exercise set from the server.
     * @param event
     * @returns New promise for a resolve or reject.
     */
    const getExerciseSetFromServer = () => new Promise((resolve, reject) => {
      const exerciseAmount = document.querySelector('#amount').value;
      const exerciseSubjects = getExerciseSubjects();

      fetch(`${baseUrl}opgaver`, {
          method: 'GET',
          headers: {
            subjects: exerciseSubjects,
            amount: exerciseAmount,
          },
        })
        .then((response) => response.json())
        .then((data) => {
          resolve(data);
          // console.log(data);
        })
        .catch((error) => reject(error));
    });

    /**
     * Gets the exercises from the checkboxes.
     * @returns {str} The exercise subjects
     */
    const getExerciseSubjects = () => {
      const elements = document.querySelector('#emneVælger').children;
      let exerciseSubjects = '';
      [...elements].forEach((element) => {
        exerciseSubjects += getCheckedExerciseSubject(element);
      });

      return exerciseSubjects;
    };

    /**
     * Gets the checked off subjects from check boxes.
     * @param element
     * @returns {str} The chosen exercise subject element ids
     */
    const getCheckedExerciseSubject = (element) => {
      if (element.checked) {
        return `${element.id},`;
      }
      return '';
    };

    /**
     * Builds a page for the generated exercise set.
     * @param {obj[]} exerciseSet
     */
    const buildExercisePage = (exerciseSet) => {
      clearDom();
      const exerciseForm = createExerciseForm();

      addExercisesToExerciseForm(exerciseForm, exerciseSet);
      addButtonToExerciseForm(exerciseForm, exerciseSet);

      document.body.appendChild(exerciseForm);

      giveFormAction(exerciseSet);
    };

    /**
     * Clears the document
     */
    const clearDom = () => {
      document.body.innerHTML = '';
    };

    /**
     * Function for making an exercise form.
     * @returns {*} An exercise form
     */
    const createExerciseForm = () => {
      const exerciseForm = document.createElement('form');
      exerciseForm.setAttribute('id', 'exerciseForm');
      return exerciseForm;
    };

    /**
     * Function for adding an exercise to the exercise form.
     * @param {*} exerciseForm
     * @param {obj[]} exerciseSet
     */
    const addExercisesToExerciseForm = (exerciseForm, exerciseSet) => {
      let i = 1;
      exerciseSet.forEach((exercise) => {
        addSingleExerciseToExerciseForm(i, exercise, exerciseForm);
        i++;
      });
    };

    /**
     * Function for adding a single exercise to a exercise form.
     * @param {number} i
     * @param {{}} exercise
     * @param {*} exerciseForm
     */
    const addSingleExerciseToExerciseForm = (i, exercise, exerciseForm) => {
      const exerciseDiv = document.createElement('div');
      exerciseDiv.setAttribute('class', 'exercise');

      addExerciseHeader(i, exercise, exerciseDiv);
      addExerciseText(exercise, exerciseDiv);
      addExerciseVars(exercise, exerciseDiv);
      addExerciseInputField(i, exerciseDiv);

      exerciseForm.appendChild(exerciseDiv);
    };

    /**
     * Function for adding header of the exercise.
     * @param {number} i
     * @param {{}} exercise
     * @param {*} exerciseDiv
     */
    const addExerciseHeader = (i, exercise, exerciseDiv) => {
      const exerciseHeader = document.createElement('h1');
      exerciseHeader.innerHTML = `Spørgsmål ${i}`;
      // eslint-disable-next-line no-param-reassign
      exercise.questionNumber = i;
      exerciseDiv.appendChild(exerciseHeader);
    };

    /**
     * Function from adding text from the exercise.
     * @param {{}} exercise
     * @param {*} exerciseDiv
     */
    const addExerciseText = (exercise, exerciseDiv) => {
      const questionText = document.createElement('p');
      questionText.innerHTML = exercise.txt;
      exerciseDiv.appendChild(questionText);
    };

    /**
     * Function from adding variables from the exercise.
     * @param {{}} exercise
     * @param {*} exerciseDiv
     */
    const addExerciseVars = (exercise, exerciseDiv) => {
      const exerciseVars = Object.values(exercise.exerciseVars);

      exerciseVars.forEach((eVar) => {
        const questionText = document.createElement('p');
        questionText.setAttribute('class', 'mathTex');
        convert(eVar, questionText);
        exerciseDiv.appendChild(questionText);
      });
    };

    /**
     * Function for adding a input field for the exercise.
     * @param {number} i
     * @param {*} exerciseDiv
     */
    const addExerciseInputField = (i, exerciseDiv) => {
      const textField = document.createElement('input');
      textField.setAttribute('required', '1');
      textField.setAttribute('id', `exercise${i}`);
      exerciseDiv.appendChild(textField);
    };

    /**
     * Function for adding a submit button for the exercise form.
     * @param {*} exerciseForm
     */
    const addButtonToExerciseForm = (exerciseForm) => {
      const submitButton = document.createElement('input');
      submitButton.setAttribute('type', 'submit');
      submitButton.setAttribute('value', 'kontroller dine svar');
      exerciseForm.appendChild(submitButton);
    };

    /**
     * Function that makes the submit button to get answers for the exercises.
     * @param {*} exerciseSet
     */
    const giveFormAction = (exerciseSet) => {
      document.querySelector('#exerciseForm').addEventListener('submit', (event) => {
        event.preventDefault();
        exerciseSet.forEach(exercise => {
          exercise.questionAnswers = document.querySelector(
            `#exercise${exercise.questionNumber}`).value;
        });
        generateResultPage(exerciseSet);
      });
    };

    const generateResultPage = (exerciseSet) => {
      clearDom();
      checkAnswer(exerciseSet);
    }

    const checkAnswer = (exerciseSet) => {
      let userPoints = 0;
      let totalPoints = 0;

      const container = document.createElement("div");
      container.setAttribute('class', 'container');

      exerciseSet.forEach(exercise => {
        let userAnswerValue = null;
        totalPoints = totalPoints + exercise.point;
        /* Det her burde være sin egen funktion senere */
        if (exercise.questionAnswers == exercise.facit) {
          userAnswerValue = true;
          userPoints = userPoints + exercise.point;
        } else userAnswerValue = false;

        const div = document.createElement("div");
        const questionText = document.createElement("p");
        const yourAnswer = document.createElement("p");

        div.setAttribute('class', 'answer');

        questionText.innerHTML = (exercise.txt) + ("<br />") + ("Spørgsmålstype: " + exercise.type);
        yourAnswer.innerHTML = `Dit svar: ${exercise.questionAnswers}`;

        if (userAnswerValue == true) {
          yourAnswer.style.backgroundColor = "green";
          yourAnswer.innerHTML = yourAnswer.innerHTML + ("<br />") + ("Rigtigt");
        } else {
          yourAnswer.style.backgroundColor = "red";
          yourAnswer.innerHTML = yourAnswer.innerHTML + ("<br />") + ("Forkert, Facit: ") + exercise.facit;
        }


        div.appendChild(questionText);
        addExerciseVars(exercise, div);
        div.append(yourAnswer);
        container.appendChild(div);
        document.body.appendChild(container);
      });
    }
  </script>
</body>

</html>