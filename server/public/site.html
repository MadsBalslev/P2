<!DOCTYPE html>

<head>
    <title>P2 Projekt</title>
    <link rel='icon' type='image/png' href='./favicon.png' />
    <meta charset="UTF-8">
</head>

<body>
    <form id='form'>
        <label for='eksamenssætTypeVælger'><b>Vælg eksamenssæt type</b></label><br>

        <label for='exerciseAmount'></label>

        <!--
        <select id='eksamenssætTypeVælger' name='eksamenssætType'>
            <option value='generisk'>Generisk</option>
            <option value='emneBestemt'>Emne bestemt</option>
            <option value='personlig'>Personlig</option>
        </select><br><br>
        -->

        <div id='emneVælger'>
            <label for='emneVælger' hidden><b>Inkluder Emner:</b></label>
            <input type="checkbox" id="andengradspolynomiumOgLigning" name="andengradspolynomiumOgLigning" value="true">
            <label for="andengradspolynomiumOgLigning">Andengradspolynomium og -ligning</label><br>

            <input type="checkbox" id="talOgRegnearter" name="talOgRegnearter" value="true">
            <label for="talOgRegnearter">Tal og regnearter</label><br>

            <input type="checkbox" id="ligninger" name="ligninger" value="true">
            <label for="ligninger">Ligninger</label><br>

            <input type="checkbox" id="trigonometri" name="trigonometri" value="true">
            <label for="trigonometri">Trigonometri</label><br>

            <input type="checkbox" id="funktioner" name="funktioner" value="true">
            <label for="funktioner">Funktioner</label><br>

            <input type="checkbox" id="geometri" name="geometri" value="true">
            <label for="geometri">Geometri</label><br>

            <input type="checkbox" id="differebtialregning" name="differebtialregning" value="true">
            <label for="differebtialregning">Differentialregning</label><br>

            <input type="checkbox" id="sandsynlighedOgKombinatorik" name="sandsynlighedOgKombinatorik" value="true">
            <label for="sandsynlighedOgKombinatorik">Sandsynlighed</label><br>

            <input type="checkbox" id="statistik" name="statistik" value="true">
            <label for="statistik">Statistik</label><br>

            <input type="checkbox" id="regression" name="regression" value="true">
            <label for="regression">Regression</label><br>

            <input type="checkbox" id="vektor2d" name="vektorerI2d" value="true">
            <label for="vektorerI2d">Vektorer i 2D</label><br>

            <input type="checkbox" id="vektorerI3d" name="vektorerI3d" value="true">
            <label for="vektorerI3d">Vektorer i 3D</label><br>

            <input type="checkbox" id="vektorfunktioner" name="vektorfunktioner" value="true">
            <label for="vektorfunktioner">Vektorfunktioner</label><br>

            <input type="checkbox" id="infinitesimalregning" name="infinitesimalregning" value="true">
            <label for="infinitesimalregning">Infinitesimalregning</label><br>

            <input type="checkbox" id="integralregning" name="integralregning" value="true">
            <label for="integralregning">Integralregning</label><br>

            <input type="checkbox" id="funktionerAfToVariable" name="funktionerAfToVariable" value="true">
            <label for="funktionerAfToVariable">Funktioner af to variable</label><br>
        </div><br>

        <label for="amount">Hvor mange opgaver vil du lave?</label>
        <input type="number" id="amount">
        <br>

        <input type='submit' value='Indsend'>
    </form>
</body>
</body>

<!--
<script>
    const eksamnessætTypeVælger = document.querySelector('#eksamenssætTypeVælger');
    const emneVælger = document.querySelector('#emneVælger');

    eksamnessætTypeVælger.addEventListener('input', () => {
        if (eksamnessætTypeVælger.value === 'emneBestemt') {
            emneVælger.removeAttribute('hidden');
        } else if (eksamnessætTypeVælger.value !== 'emneBestemt') {
            emneVælger.setAttribute('hidden', '');
        }
    });
</script>
-->
<script>
    document.querySelector('#form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const exerciseSet = await getExerciseSetFromServer(event);
        buildExercisePage(exerciseSet);
    });


    const getExerciseSetFromServer = (event) => {
        return new Promise((resolve, reject) => {
            exerciseAmount = document.querySelector('#amount').value;
            exerciseSubjects = getExerciseSubjects();

            fetch('http://localhost:8080/opgaver', {
                method: 'GET',
                headers: {
                    subjects: exerciseSubjects,
                    amount: exerciseAmount
                }
            })
                .then(response => response.json())
                .then(data => resolve(data))
                .catch(error => reject(error));
        });
    };

    const getExerciseSubjects = () => {
        let elements = document.querySelector('#emneVælger').children;
        let exerciseSubjects = '';
        [...elements].forEach(element => {
            exerciseSubjects += getCheckedExerciseSubject(element);
        });

        return exerciseSubjects;
    };

    const getCheckedExerciseSubject = (element) => {
        if (element.checked) {
            return `${element.id},`;
        } else {
            return '';
        }
    };

    const buildExercisePage = (exerciseSet) => {
        clearDom();
        const exerciseForm = createExerciseForm();
        addExercisesToExerciseForm(exerciseForm, exerciseSet);
        addButtonToExerciseForm(exerciseForm, exerciseSet);
        document.body.appendChild(exerciseForm);
        giveFormAction(exerciseSet);
    };

    function clearDom() {
        document.body.innerHTML = '';
    }

    function createExerciseForm() {
        const exerciseForm = document.createElement("form");
        exerciseForm.setAttribute('id', 'exerciseForm');
        return exerciseForm;
    }

    function addExercisesToExerciseForm(exerciseForm, exerciseSet) {
        let i = 1;
        exerciseSet.forEach((exercise) => {
            i = addSingleExerciseToExerciseForm(i, exercise, exerciseForm);
        });
    }

    function addSingleExerciseToExerciseForm(i, exercise, exerciseForm) {
        const exerciseDiv = document.createElement("div");
        addExerciseHeader(i, exercise, exerciseDiv);
        addExerciseText(exercise, exerciseDiv);
        addExerciseInputField(i, exerciseDiv);
        exerciseForm.appendChild(exerciseDiv);
        i += 1;
        return i;
    }

    function addExerciseHeader(i, exercise, exerciseDiv) {
        const exerciseHeader = document.createElement('h1');
        exerciseHeader.innerHTML = `Spørgsmål ${i}`;
        exercise.questionNumber = i;
        exerciseDiv.appendChild(exerciseHeader);
    }

    function addExerciseText(exercise, exerciseDiv) {
        const questionText = document.createElement("p");
        questionText.innerHTML = exercise.txt;
        exerciseDiv.appendChild(questionText);
    }

    function addExerciseInputField(i, exerciseDiv) {
        const textField = document.createElement("input");
        textField.setAttribute("required", "1");
        textField.setAttribute("id", `exercise${i}`);
        exerciseDiv.appendChild(textField);
    }

    function addButtonToExerciseForm(exerciseForm, exerciseSet) {
        const submitButton = document.createElement("input");
        submitButton.setAttribute("type", `submit`);
        submitButton.setAttribute("value", `kontroller dine svar`);
        exerciseForm.appendChild(submitButton);
    }

    function giveFormAction(exerciseSet) {
        document.querySelector('#exerciseForm').addEventListener('submit', (event) => {
            event.preventDefault();
            exerciseSet.forEach(exercise => {
                exercise.questionAnswers = document.querySelector(`#exercise${exercise.questionNumber}`).value;
            });

            fetch('http://localhost:8080/resultat', {
                method: 'POST',
                header: {
                    'content-Type': 'application/json',
                },
                body: JSON.stringify(exerciseSet),
            })
                .then(response => response.text())
                .then(resultPage => document.body.innerHTML = resultPage);
        });
    }
</script>

</html>